electricity:
  utility_meter:
    electricity_meter_a_daily:
      source: sensor.a_energy
      name: Daily Energy A
      cycle: daily
      delta_values: true
      tariffs:
        - day
        - night
    electricity_meter_a_monthly:
      source: sensor.a_energy
      name: Monthly Energy A
      cycle: monthly
      delta_values: true
      tariffs:
        - day
        - night
    electricity_meter_b_daily:
      source: sensor.b_energy
      name: Daily Energy B
      cycle: daily
      delta_values: true
      tariffs:
        - day
        - night
    electricity_meter_b_monthly:
      source: sensor.b_energy
      name: Monthly Energy B
      cycle: monthly
      delta_values: true
      tariffs:
        - day
        - night
    electricity_meter_c_daily:
      source: sensor.c_energy
      name: Daily Energy C
      cycle: daily
      delta_values: true
      tariffs:
        - day
        - night
    electricity_meter_c_monthly:
      source: sensor.c_energy
      name: Monthly Energy C
      cycle: monthly
      delta_values: true
      tariffs:
        - day
        - night

  input_number:
    tariff_day:
      min: 7
      max: 9
      initial: 7.61
      step: 0.01
      mode: box
      icon: mdi:cash-multiple
      unit_of_measurement: "₽/кВт*ч"

    tariff_night:
      min: 3
      max: 5
      initial: 3.27
      step: 0.01
      mode: box
      icon: mdi:cash-multiple
      unit_of_measurement: "₽/кВт*ч"

  sensor:
    - platform: template
      sensors:
        daily_total_energy_day:
          friendly_name: "Daily Energy Total Day"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_daily_day'))
            and is_number(states('sensor.electricity_meter_b_daily_day'))
            and is_number(states('sensor.electricity_meter_c_daily_day')) %}
              {{ states('sensor.electricity_meter_a_daily_day') | float 
              + states('sensor.electricity_meter_b_daily_day') | float 
              + states('sensor.electricity_meter_c_daily_day') | float }}
            {% else %}
              None
            {% endif %}

        daily_total_energy_night:
          friendly_name: "Daily Energy Total Night"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_daily_night'))
            and is_number(states('sensor.electricity_meter_b_daily_night'))
            and is_number(states('sensor.electricity_meter_c_daily_night')) %}
              {{ states('sensor.electricity_meter_a_daily_night') | float 
              + states('sensor.electricity_meter_b_daily_night') | float 
              + states('sensor.electricity_meter_c_daily_night') | float }}
            {% else %}
              None
            {% endif %}

        daily_total_energy:
          friendly_name: "Daily Energy Total"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_daily_day')) 
            and is_number(states('sensor.electricity_meter_a_daily_night'))
            and is_number(states('sensor.electricity_meter_b_daily_day'))
            and is_number(states('sensor.electricity_meter_b_daily_night'))
            and is_number(states('sensor.electricity_meter_c_daily_day'))
            and is_number(states('sensor.electricity_meter_c_daily_night')) %}
              {{ states('sensor.electricity_meter_a_daily_day') | float 
              + states('sensor.electricity_meter_a_daily_night') | float 
              + states('sensor.electricity_meter_b_daily_day') | float 
              + states('sensor.electricity_meter_b_daily_night') | float 
              + states('sensor.electricity_meter_c_daily_day') | float 
              + states('sensor.electricity_meter_c_daily_night') | float }}
            {% else %}
              None
            {% endif %}

        daily_total_energy_a:
          friendly_name: "Daily Energy A Total"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_daily_day')) 
            and is_number(states('sensor.electricity_meter_a_daily_night')) %}
              {{ states('sensor.electricity_meter_a_daily_day') | float 
              + states('sensor.electricity_meter_a_daily_night') | float }}
            {% else %}
              None
            {% endif %}

        money_daily_total_energy_day:
          friendly_name: "Стоимость за текущий день (день)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.daily_total_energy_day") | float) * (states("input_number.tariff_day") | float) | round }}'

        money_daily_total_energy_night:
          friendly_name: "Стоимость за текущий день (ночь)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.daily_total_energy_night") | float) * (states("input_number.tariff_night") | float) | round }}'

        money_daily_total_energy:
          friendly_name: "Стоимость за текущий день"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ states("sensor.money_daily_total_energy_day") | float + states("sensor.money_daily_total_energy_night") | float }}'

        money_daily_energy_a_day:
          friendly_name: "Стоимость A за текущий день (день)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.electricity_meter_a_daily_day") | float) * (states("input_number.tariff_day") | float) | round }}'

        money_daily_energy_a_night:
          friendly_name: "Стоимость A за текущий день (ночь)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.electricity_meter_a_daily_night") | float) * (states("input_number.tariff_night") | float) | round }}'

        money_daily_energy_a:
          friendly_name: "Стоимость A за текущий день"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ states("sensor.money_daily_energy_a_day") | float + states("sensor.money_daily_energy_a_night") | float }}'

        monthly_total_energy_day:
          friendly_name: "Monthly Energy Total Day"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_monthly_day'))
            and is_number(states('sensor.electricity_meter_b_monthly_day'))
            and is_number(states('sensor.electricity_meter_c_monthly_day')) %}
              {{ states('sensor.electricity_meter_a_monthly_day') | float 
              + states('sensor.electricity_meter_b_monthly_day') | float 
              + states('sensor.electricity_meter_c_monthly_day') | float }}
            {% else %}
              None
            {% endif %}

        monthly_total_energy_night:
          friendly_name: "Monthly Energy Total Night"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_monthly_night'))
            and is_number(states('sensor.electricity_meter_b_monthly_night'))
            and is_number(states('sensor.electricity_meter_c_monthly_night')) %}
              {{ states('sensor.electricity_meter_a_monthly_night') | float 
              + states('sensor.electricity_meter_b_monthly_night') | float 
              + states('sensor.electricity_meter_c_monthly_night') | float }}
            {% else %}
              None
            {% endif %}

        monthly_total_energy:
          friendly_name: "Monthly Energy Total"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_monthly_day')) 
            and is_number(states('sensor.electricity_meter_a_monthly_night'))
            and is_number(states('sensor.electricity_meter_b_monthly_day'))
            and is_number(states('sensor.electricity_meter_b_monthly_night'))
            and is_number(states('sensor.electricity_meter_c_monthly_day'))
            and is_number(states('sensor.electricity_meter_c_monthly_night')) %}
              {{ states('sensor.electricity_meter_a_monthly_day') | float 
              + states('sensor.electricity_meter_a_monthly_night') | float 
              + states('sensor.electricity_meter_b_monthly_day') | float 
              + states('sensor.electricity_meter_b_monthly_night') | float 
              + states('sensor.electricity_meter_c_monthly_day') | float 
              + states('sensor.electricity_meter_c_monthly_night') | float }}
            {% else %}
              None
            {% endif %}

        monthly_total_energy_a:
          friendly_name: "Monthly Energy A Total"
          device_class: energy
          unit_of_measurement: kWh
          icon_template: mdi:flash
          value_template: >
            {% if is_number(states('sensor.electricity_meter_a_monthly_day')) 
            and is_number(states('sensor.electricity_meter_a_monthly_night')) %}
              {{ states('sensor.electricity_meter_a_monthly_day') | float 
              + states('sensor.electricity_meter_a_monthly_night') | float }}
            {% else %}
              None
            {% endif %}

        money_monthly_total_energy_day:
          friendly_name: "Стоимость за текущий месяц (день)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.monthly_total_energy_day") | float) * (states("input_number.tariff_day") | float) | round }}'

        money_monthly_total_energy_night:
          friendly_name: "Стоимость за текущий месяц (ночь)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.monthly_total_energy_night") | float) * (states("input_number.tariff_night") | float) | round }}'

        money_monthly_total_energy:
          friendly_name: "Стоимость за текущий месяц"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ states("sensor.money_monthly_total_energy_day") | float + states("sensor.money_monthly_total_energy_night") | float }}'

        money_monthly_energy_a_day:
          friendly_name: "Стоимость A за текущий месяц (день)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.electricity_meter_a_monthly_day") | float) * (states("input_number.tariff_day") | float) | round }}'

        money_monthly_energy_a_night:
          friendly_name: "Стоимость A за текущий месяц (ночь)"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ (states("sensor.electricity_meter_a_monthly_night") | float) * (states("input_number.tariff_night") | float) | round }}'

        money_monthly_energy_a:
          friendly_name: "Стоимость A за текущий месяц"
          unit_of_measurement: "₽"
          icon_template: mdi:cash-multiple
          value_template: '{{ states("sensor.money_monthly_energy_a_day") | float + states("sensor.money_monthly_energy_a_night") | float }}'

  automation:
    - alias: Set day tariff
      initial_state: true
      trigger:
        - platform: time
          at: "07:00:00"
      action:
        - service: select.select_option
          entity_id:
            - select.electricity_meter_a_daily
            - select.electricity_meter_a_monthly
            - select.electricity_meter_b_daily
            - select.electricity_meter_b_monthly
            - select.electricity_meter_c_daily
            - select.electricity_meter_c_monthly
          data:
            option: day

    - alias: Set night tariff
      initial_state: true
      trigger:
        - platform: time
          at: "23:00:00"
      action:
        - service: select.select_option
          entity_id:
            - select.electricity_meter_a_daily
            - select.electricity_meter_a_monthly
            - select.electricity_meter_b_daily
            - select.electricity_meter_b_monthly
            - select.electricity_meter_c_daily
            - select.electricity_meter_c_monthly
          data:
            option: night
