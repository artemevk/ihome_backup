perimeter_defenses:
  template:
    - sensor:
        - default_entity_id: sensor.alarm_control_panel_arm_mode
          name: "Режим охраны"
          icon: mdi:shield
          state: |
            {%- if states('alarm_control_panel.master') == 'disarmed' %}{{" Нет охраны"}}
            {% elif states('alarm_control_panel.master') == 'armed_home' %}{{" Дома"}}
            {% elif states('alarm_control_panel.master') == 'armed_away' %}{{" Не дома"}}
            {% endif -%}

  script:
    creating_photos:
      sequence:
        - action: camera.snapshot
          target:
            entity_id: camera.parking_camera_mainstream
          data:
            filename: "/media/parking_camera_last_snapshot.jpg"
        - action: camera.snapshot
          target:
            entity_id: camera.porch_camera_mainstream
          data:
            filename: "/media/porch_camera_last_snapshot.jpg"
        - action: camera.snapshot
          target:
            entity_id: camera.courtyard_camera_mainstream
          data:
            filename: "/media/courtyard_camera_last_snapshot.jpg"
        - delay: 00:00:06

    create_photos:
      sequence:
        - if:
            - condition: template
              value_template: "{{ state_attr('sun.sun', 'elevation') < -2 }}"
          then:
            - sequence:
                - action: automation.trigger
                  data:
                    skip_condition: false
                  target:
                    entity_id: automation.switch_on_outdoor_light
                - delay: 5
                - action: script.creating_photos
          else:
            - action: script.creating_photos

    update_todo_departure_prep:
      sequence:
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Вода в доме
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Вода в бане
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Калитка
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Помыть посуду в бане
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Забрать мусор
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Баня. Чайник не на базе
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Открыт туалет
            status: needs_action
        - action: todo.update_item
          target:
            entity_id: todo.departure_prep
          data:
            item: Зеркало в бане
            status: needs_action

    send_photos:
      sequence:
        - service: telegram_bot.send_photo
          data:
            file: "/media/parking_camera_last_snapshot.jpg"
            target: [!secret tlg_user1_id, !secret tlg_user3_id]
            disable_notification: true
        - service: telegram_bot.send_photo
          data:
            file: "/media/porch_camera_last_snapshot.jpg"
            target: [!secret tlg_user1_id, !secret tlg_user3_id]
            disable_notification: true
        - service: telegram_bot.send_photo
          data:
            file: "/media/courtyard_camera_last_snapshot.jpg"
            target: [!secret tlg_user1_id, !secret tlg_user3_id]

  automation:
    - alias: "motion_notification"
      id: motion_notification
      trigger:
        - platform: state
          entity_id:
            - binary_sensor.cameras_motion
            - binary_sensor.porch_motion_protect_occupancy
          to: "on"
      condition:
        alias: "alarm not disarmed"
        not:
          - condition: state
            entity_id: alarm_control_panel.master
            state: disarmed
      action:
        - service: script.create_photos
        - service: script.send_photos
        - service: notify.alarm
          data:
            title: "Охрана"
            message: "Зафиксировано движение"
            data:
              url: "/lovelace/security"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              ledColor: red
              image: "/media/local/porch_camera_last_snapshot.jpg"
              content-type: image
              push:
                sound:
                  name: "default"
                  critical: 1
                  volume: 0.2
              actions:
                - action: "ALARM" # The key you are sending for the event
                  title: "Sound Alarm" # The button title
                  destructive: true
                  icon: "sfsymbols:bell"
                - action: "SILENCE"
                  title: "Silence Alarm"
                  icon: "sfsymbols:bell.slash"

    - id: Напоминание о необходимости снять дом с охраны
      alias: reminder_to_disarm_the_house
      initial_state: false
      trigger:
        platform: state
        entity_id: device_tracker.artemevk
        to: "home"
      condition:
        not:
          - condition: state
            entity_id: alarm_control_panel.master
            state: "disarmed"
      action:
        - service: notify.mobile_app_artemevk
          data:
            title: "Охрана"
            message: "Не забудь снять дом с охраны"
            data:
              url: "/lovelace/security"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              push:
                sound:
                  name: "default"
                  critical: 1
                  volume: 0.2
              actions:
                - action: "disarmed" # The key you are sending for the event
                  title: "Снять с охраны"
                  icon: "sfsymbols:lock.open"

    - id: Напоминание о необходимости снять дом с охраны АПН
      alias: reminder_to_disarm_the_house_artemevp
      initial_state: false
      trigger:
        platform: state
        entity_id: device_tracker.artemevp
        to: "home"
      condition:
        not:
          - condition: state
            entity_id: alarm_control_panel.master
            state: "disarmed"
      action:
        - service: notify.mobile_app_artemevp
          data:
            title: "Охрана"
            message: "Не забудь снять дом с охраны"
            data:
              url: "/lovelace/security"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              push:
                sound:
                  name: "default"
                  critical: 1
                  volume: 0.2
              actions:
                - action: "disarmed" # The key you are sending for the event
                  title: "Снять с охраны"
                  icon: "sfsymbols:lock.open"

    - alias: "disarmed"
      trigger:
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            action: "disarmed"
      action:
        - service: alarm_control_panel.alarm_disarm
          target:
            entity_id: alarm_control_panel.master

    - alias: "Trigger alarm while armed away"
      trigger:
        - platform: state
          entity_id: binary_sensor.entrance_door_contact
          to: "on"
        - platform: state
          entity_id: binary_sensor.open_kitchen_motion_sensor
          to: "on"
      condition:
        - condition: state
          entity_id: alarm_control_panel.master
          state: armed_away
      action:
        service: alarm_control_panel.alarm_trigger
        target:
          entity_id: alarm_control_panel.master

    - alias: "Trigger alarm while armed home"
      triggers:
        - trigger: state
          entity_id:
            - binary_sensor.porch_motion_protect_occupancy
            - binary_sensor.cameras_motion
          to: "on"
      conditions:
        - condition: state
          entity_id: alarm_control_panel.master
          state: armed_home
        - condition: state
          entity_id: binary_sensor.porch_motion_protect_occupancy
          state: "on"
        - condition: state
          entity_id: binary_sensor.cameras_motion
          state: "on"
      actions:
        - action: alarm_control_panel.alarm_trigger
          target:
            entity_id: alarm_control_panel.master

    - alias: "Send notification when alarm triggered"
      trigger:
        - platform: state
          entity_id: alarm_control_panel.master
          to: "triggered"
      action:
        - service: notify.alarm
          data:
            title: "Охрана"
            message: "Сработала сигнализация!"
            data:
              url: "/lovelace/security"
              push:
                sound:
                  name: "alarm.caf"
                  critical: 1
                  volume: 1.0
              actions:
                - action: "ALARM" # The key you are sending for the event
                  title: "Sound Alarm" # The button title
                  destructive: true
                  icon: "sfsymbols:bell"
                - action: "SILENCE"
                  title: "Silence Alarm"
                  icon: "sfsymbols:bell.slash"
                - action: "disarmed"
                  title: "Снять с охраны"
                  icon: "sfsymbols:lock.open"

    - id: "automatic arming"
      alias: "automatic arming"
      trigger:
        - platform: template
          value_template: "{{ states('zone.home') | int == 0 }}"
      condition:
        not:
          - condition: state
            entity_id: alarm_control_panel.master
            state: "armed_away"
      action:
        - service: alarm_control_panel.alarm_arm_away
          target:
            entity_id: alarm_control_panel.master

    - id: "automatic disarming"
      alias: "automatic disarming"
      trigger:
        - platform: template
          value_template: "{{ states('zone.home') | int > 0 }}"
      condition:
        not:
          - condition: state
            entity_id: alarm_control_panel.master
            state: "disarmed"
      actions:
        - action: alarm_control_panel.alarm_disarm
          target:
            entity_id: alarm_control_panel.master

    - id: "alarm notify armed"
      alias: "alarm notify armed"
      trigger:
        - platform: state
          entity_id: alarm_control_panel.master
          to:
            - "armed_away"
      actions:
        - action: script.create_photos
        - action: script.send_photos
        - action: notify.alarm
          data:
            title: "Охрана"
            message: |
              Дом поставлен на охрану. Проверьте чек-лист.
            data:
              url: "/lovelace/security"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              ledColor: red
              image: "/media/local/porch_camera_last_snapshot.jpg"
              content-type: image

    - id: "alarm notify disarmed"
      alias: "alarm notify disarmed"
      trigger:
        - platform: state
          entity_id: alarm_control_panel.master
          not_from:
            - "arming"
            - "armed_home"
          to:
            - "disarmed"
      actions:
        - action: notify.alarm
          data:
            title: "Охрана"
            message: Дом снят с охраны.
            data:
              url: "/lovelace/security"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              ledColor: red
        - action: script.update_todo_departure_prep

    - id: tlg_alarm_menu
      alias: "tlg_alarm_menu"
      trigger:
        - platform: event
          event_type: telegram_callback # вызов с клавиатуры
          event_data:
            command: "/alarm_panel"
      action:
        - service: telegram_bot.delete_message
          data:
            chat_id: "{{ trigger.event.data.chat_id }}"
            message_id: "{{ trigger.event.data.message.message_id }}"
        - service: telegram_bot.send_message
          data_template:
            target: "{{ trigger.event.data.user_id }}"
            title: "#охрана"
            message: |
              {{'\U0001F6A8'}} Меню охраны
              Текущий режим:
              {{- " "}}{{ states('sensor.alarm_control_panel_arm_mode') }}
              Выберите режим:
            inline_keyboard: &alarm_keyb
              - "Не дома:/alarm_arm_away, Дома:/alarm_arm_home"
              - "Нет охраны:/alarm_disarm"
              - "Главное меню:/mm"

    - id: tlg_action_disarm
      alias: "tlg_action_disarm"
      initial_state: true
      mode: single
      triggers:
        - trigger: event
          event_type: telegram_callback
          event_data:
            command: /alarm_disarm
      actions:
        - action: alarm_control_panel.alarm_disarm
          target:
            entity_id: alarm_control_panel.master
        - service: telegram_bot.edit_message
          data:
            chat_id: "{{ trigger.event.data.chat_id }}"
            message_id: "{{ trigger.event.data.message.message_id }}"
            title: "#охрана"
            message: |
              {{'\U0001F6A8'}} Меню охраны
              Текущий режим:
              {{- " "}}{{ states('sensor.alarm_control_panel_arm_mode') }}
              Выберите режим:
            inline_keyboard: *alarm_keyb

    - id: tlg_action_arm_home
      alias: "tlg_action_arm_home"
      initial_state: true
      mode: single
      triggers:
        - trigger: event
          event_type: telegram_callback
          event_data:
            command: /alarm_arm_home
      actions:
        - action: alarm_control_panel.alarm_arm_home
          target:
            entity_id: alarm_control_panel.master
        - service: telegram_bot.edit_message
          data:
            chat_id: "{{ trigger.event.data.chat_id }}"
            message_id: "{{ trigger.event.data.message.message_id }}"
            title: "#охрана"
            message: |
              {{'\U0001F6A8'}} Меню охраны
              Текущий режим:
              {{- " "}}{{ states('sensor.alarm_control_panel_arm_mode') }}
              Выберите режим:
            inline_keyboard: *alarm_keyb

    - id: tlg_action_arm_away
      alias: "tlg_action_arm_away"
      initial_state: true
      mode: single
      triggers:
        - trigger: event
          event_type: telegram_callback
          event_data:
            command: /alarm_arm_away
      actions:
        - action: alarm_control_panel.alarm_arm_away
          target:
            entity_id: alarm_control_panel.master
        - action: todo.get_items
          target:
            entity_id: todo.departure_prep
          data:
            status:
              - needs_action
          response_variable: todo_list
        - action: telegram_bot.edit_message
          data:
            chat_id: "{{ trigger.event.data.chat_id }}"
            message_id: "{{ trigger.event.data.message.message_id }}"
            title: "#охрана"
            message: |
              Команда принята. Время постановки на охрану 30 секунд. Ожидайте подтверждение.
              Проверьте чек-лист:
              {%- set tasks = todo_list['todo.departure_prep']['items'] -%}
              {% set headings = tasks | map(attribute='summary') | list %}
              - {{ (headings | join('\n- ')) }}
        - delay: 31
        - action: telegram_bot.edit_message
          data:
            chat_id: "{{ trigger.event.data.chat_id }}"
            message_id: "{{ trigger.event.data.message.message_id }}"
            title: "#охрана"
            message: |
              {{'\U0001F6A8'}} Меню охраны
              Текущий режим:
              {{- " "}}{{ states('sensor.alarm_control_panel_arm_mode') }}
              Выберите режим:
            inline_keyboard: *alarm_keyb
