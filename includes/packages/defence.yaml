defence:
  template:
    - sensor:
        - default_entity_id: sensor.msg_power_protection
          name: "Уведомление о превышение потребления электроэнергии"
          state: |
            {{"\U000026A1"}} Превышено потребление электроэнергии!
            A: {{ states('sensor.a_power') }}; B: {{ states('sensor.b_power') }}; C:{{ states('sensor.c_power') }}
          icon: mdi:transmission-tower

        - default_entity_id: sensor.msg_temperature_protection
          name: "Уведомление о падении температуры ниже 4 °C"
          state: |
            Спальня на первом этаже: {{ states('sensor.1st_floor_bedroom_temperature') }} °C
            Детская: {{ states('sensor.childrens_room_climate_temperature') }} °C
            Кухня-гостиная: {{ states('sensor.open_kitchen_temperature') }} °C
            Второй этаж: {{ states('sensor.second_floor_climate_temperature') }} °C
            Туалет: {{ states('sensor.toilet_climate_temperature') }} °C
            Баня: {{ states('sensor.bathhouse_climate_temperature') }} °C
          icon: mdi:transmission-tower

  automation:
    - id: "water leak"
      alias: "water leak"
      description: "water leak"
      mode: single
      triggers:
        - trigger: state
          entity_id:
            - binary_sensor.toilet_water_leak
          to: "on"
      action:
        - service: notify.mobile_app_artemevk
          data:
            title: "Протечка!"
            message: "Обнаружена протечка!"
            data:
              url: "/lovelace/main"
              push:
                sound:
                  name: "alarm.caf"
                  critical: 1
                  volume: 1.0

    - id: "power_protection"
      alias: "power protection"
      description: "power protection"
      mode: single
      triggers:
        - trigger: numeric_state
          entity_id:
            - sensor.a_power
            - sensor.b_power
            - sensor.c_power
          for:
            hours: 0
            minutes: 1
            seconds: 0
          above: 6700
      action:
        - service: notify.mobile_app_artemevk
          data:
            title: "Потребление электроэнергии!"
            message: "{{ states('sensor.msg_power_protection') }}"
            data:
              url: "/lovelace/main"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              push:
                sound:
                  name: "alarm.caf"
                  critical: 1
                  volume: 0.2
        - service: telegram_bot.send_message
          data_template:
            target: !secret tlg_user1_id
            title: "#alarm"
            message: "{{ states('sensor.msg_power_protection') }}"
            inline_keyboard:
              - "Главное меню:/mm"

    - id: "temperature_protection"
      alias: "temperature protection"
      description: "temperature protection"
      mode: single
      triggers:
        - trigger: numeric_state
          entity_id:
            - sensor.1st_floor_bedroom_temperature
            - sensor.bathhouse_climate_temperature
            - sensor.childrens_room_climate_temperature
            - sensor.open_kitchen_temperature
            - sensor.second_floor_climate_temperature
            - sensor.toilet_climate_temperature
          for:
            hours: 0
            minutes: 5
            seconds: 0
          below: 4
      action:
        - service: notify.mobile_app_artemevk
          data:
            title: '{{"\U0001F321"}} Температура {{ trigger.entity_id }} упала ниже 4 °C!'
            message: "{{ states('sensor.msg_temperature_protection') }}"
            data:
              url: "/lovelace/main"
              importance: high
              persistent: true
              vibrationPattern: 100, 1000, 100, 1000, 100
              push:
                sound:
                  name: "alarm.caf"
                  critical: 1
                  volume: 0.2
        - service: telegram_bot.send_message
          data_template:
            target: !secret tlg_user1_id
            title: "#alarm"
            message: |
              {{"\U0001F321"}} Температура {{ trigger.entity_id }} упала ниже 4 °C!
              {{ states('sensor.msg_temperature_protection') }}
            inline_keyboard:
              - "Главное меню:/mm"
