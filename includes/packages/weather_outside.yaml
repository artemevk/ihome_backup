weather_outside:
  ## коды эмоджи для телеграмм - https://unicode.org/Public/emoji/13.1/emoji-test.txt

  template:
    - sensor:
        - default_entity_id: sensor.weather_forecast_condition
          name: "Общие погодные условия (прогноз)"
          state: >
            {% if state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'clear' %}{{"Ясно"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'partlycloudy' %}{{"Переменная облачность"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'cloudy' %}{{"Облачно"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'overcast' %}{{"Пасмурно"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'light_rain' %}{{"Слабый дождь"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'rainy' %}{{"Дождь"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'heavy_rain' %}{{"Сильный дождь"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'showers' %}{{"Ливень"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'sleet' %}{{"Слякоть"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'light_snow' %}{{"Лёгкий снег"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'snowy' %}{{"Снег"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'snowfall' %}{{"Снегопад"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'hail' %}{{"Град"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'thunderstorm' %}{{"Грозы"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'thunderstorm_with_rain' %}{{"Дождь с грозой"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'thunderstorm_with_hail' %}{{"Град с грозой"}}
            {% elif state_attr("weather.yandex_weather", "forecastHourly")[2].condition == 'sunny' %}{{"Солнечно"}}
            {% else %}{{ state_attr("weather.yandex_weather", "forecastHourly")[2].condition }}
            {% endif %}

        - default_entity_id: sensor.weather_moscow_forecast_condition
          name: "Общие погодные условия (прогноз)"
          state: >
            {% if state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'clear' %}{{"Ясно"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'partlycloudy' %}{{"Переменная облачность"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'cloudy' %}{{"Облачно"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'overcast' %}{{"Пасмурно"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'light_rain' %}{{"Слабый дождь"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'rainy' %}{{"Дождь"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'heavy_rain' %}{{"Сильный дождь"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'showers' %}{{"Ливень"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'sleet' %}{{"Слякоть"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'light_snow' %}{{"Лёгкий снег"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'snowy' %}{{"Снег"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'snowfall' %}{{"Снегопад"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'hail' %}{{"Град"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'thunderstorm' %}{{"Грозы"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'thunderstorm_with_rain' %}{{"Дождь с грозой"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'thunderstorm_with_hail' %}{{"Град с грозой"}}
            {% elif state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition == 'sunny' %}{{"Солнечно"}}
            {% else %}{{ state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].condition }}
            {% endif %}

        - default_entity_id: sensor.msg_weather
          state: |
            {{"\U0001F3E2"}} *МОСКВА:* {{ states("sensor.weather_moscow_forecast_condition")}}
            {{"\U0001F321"}} {{state_attr("weather.yandex_weather_moscow", "temperature")}} °C
            {{"\U0001F4A8"}} {{state_attr("weather.yandex_weather_moscow", "wind_speed")}} м/с
            В {{ as_timestamp(state_attr("weather.yandex_weather_moscow", "forecastHourly")[2].datetime) | timestamp_custom('%H:%M') }} {{ states('sensor.weather_moscow_forecast_condition') }}
            {{"\U0001F321"}} {{state_attr("weather.yandex_weather_moscow", "forecastHourly")[1].native_temperature}} °C
            {{ "\n" -}}{{"\U0001F3E1"}} *МАТВЕЙКОВО:* {{ states("sensor.weather_forecast_condition")}}
            {{"\U0001F321"}} {{state_attr("weather.yandex_weather", "temperature")}} °C
            {{"\U0001F4A8"}} {{state_attr("weather.yandex_weather", "wind_speed")}} м/с
            В {{ as_timestamp(state_attr("weather.yandex_weather", "forecastHourly")[2].datetime) | timestamp_custom('%H:%M') }} {{ states('sensor.weather_forecast_condition') }}
            {{"\U0001F321"}} {{state_attr("weather.yandex_weather", "forecastHourly")[2].native_temperature}} °C
            {{ "\n" -}}{{"\U0000231A"}} Данные получены в {{ as_timestamp(states("sensor.yandex_weather_data_update_time")) | timestamp_custom('%H:%M') }}

  automation:
    # Отправка ежедневного утреннего отчета о погоде
    - alias: send_morning_climate_report
      id: Утренний отчет о погоде
      initial_state: true
      trigger:
        - platform: time
          at: "07:30:00"
      action:
        - service: camera.snapshot
          target:
            entity_id: camera.courtyard_camera_mainstream
          data:
            filename: "/media/courtyard_camera_last_snapshot.jpg"
        - delay: 5
        - service: telegram_bot.send_photo
          data:
            file: "/media/courtyard_camera_last_snapshot.jpg"
            target:
              [
                !secret tlg_user1_id,
                !secret tlg_user2_id,
                !secret tlg_user3_id,
                !secret tlg_user4_id,
                !secret tlg_user5_id,
              ]
            caption: >
              {{ states('sensor.msg_weather') }}
            inline_keyboard:
              - "Главное меню:/mm"

    # Отправка отчета о погоде по запросу
    - alias: send_climate_report
      id: Отчет о погоде по запросу
      initial_state: true
      trigger:
        - platform: event
          event_type: telegram_callback
          event_data:
            command: "/forecast"
        - platform: event
          event_type: telegram_command
          event_data:
            command: "/forecast"
      action:
        - service: telegram_bot.delete_message
          data_template:
            message_id: "last"
            chat_id: "{{ trigger.event.data.chat_id }}"
        - service: telegram_bot.send_message
          data_template:
            target: "{{ trigger.event.data.user_id }}"
            disable_notification: true
            title: "#weather"
            message: >
              {{"\U0001F326"}} Команда принята, ожидайте.
        - service: camera.snapshot
          target:
            entity_id: camera.courtyard_camera_mainstream
          data:
            filename: "/media/courtyard_camera_last_snapshot.jpg"
        - delay: 00:00:05
        - service: telegram_bot.delete_message
          data_template:
            message_id: "last"
            chat_id: "{{ trigger.event.data.chat_id }}"
        - service: telegram_bot.send_photo
          data:
            file: "/media/courtyard_camera_last_snapshot.jpg"
            target: "{{ trigger.event.data.user_id }}"
            caption: >
              {{ states('sensor.msg_weather') }}
            inline_keyboard:
              - "Главное меню:/mm"
